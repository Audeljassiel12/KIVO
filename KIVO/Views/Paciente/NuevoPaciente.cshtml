@model KIVO.Models.Dto.PacienteDTO
@{
}
<div id="detallesPacienteContainer"></div>
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h3>Registro de Paciente</h3>
                </div>
                <div class="card-body">
                    <form asp-action="NuevaPaciente" method="post" id="formPaciente" novalidate enctype="multipart/form-data">
                        <div class="row">
                            <!-- Sección de Foto y Notas a la Izquierda -->
                            <div class="col-md-4 d-flex flex-column align-items-center">
                                <div class="mb-3">
                                    @if (Model.FotoPerfilUrl is null)
                                    {
                                        <img src="~/KIVO_JPG/avatar-placeholder-large-957340962e0e778eed41f03871a6b7d5.png" alt="Foto" class="img-fluid rounded-circle" id="foto-perfil">
                                    }
                                    else
                                    {
                                        <img src="@Model.FotoPerfilUrl" alt="Foto" class="img-fluid rounded-circle" id="foto-perfil">
                                    }
                                </div>
                                <label for="upload-avatar" class="btn btn-primary mb-3">Subir Foto</label>
                                <input asp-for="formFile" type="file" class="d-none" id="upload-avatar" name="formFile">

                                <div class="form-group">
                                    <label asp-for="NotasInternas">Notas Internas</label>
                                    <textarea id="miNota" asp-for="NotasInternas" class="form-control" rows="5"></textarea>
                                    <span asp-validation-for="NotasInternas" class="text-danger"></span>
                                </div>
                                <small class="form-text text-muted">Estas notas son solo visibles para los médicos.</small>
                            </div>

                            <!-- Sección de Campos de Datos a la Derecha -->
                            <div class="col-md-8">
                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label asp-for="Nombres"></label>
                                        <input asp-for="Nombres" class="form-control" placeholder="Nombre(s)">
                                        <span asp-validation-for="Nombres" class="text-danger"></span>
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label asp-for="Apellidos"></label>
                                        <input asp-for="Apellidos" class="form-control" placeholder="Apellido(s)">
                                        <span asp-validation-for="Apellidos" class="text-danger"></span>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label asp-for="Genero"></label>
                                        <select asp-for="Genero" class="form-control">
                                            <option value="male">Masculino</option>
                                            <option value="female">Femenino</option>
                                            <option value="other">Otro</option>
                                        </select>
                                        <span asp-validation-for="Genero" class="text-danger"></span>
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label asp-for="FechaNacimiento"></label>
                                        <input asp-for="FechaNacimiento" class="form-control" type="date">
                                        <span asp-validation-for="FechaNacimiento" class="text-danger"></span>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label asp-for="Email"></label>
                                    <input asp-for="Email" class="form-control" placeholder="Correo Electrónico">
                                    <span asp-validation-for="Email" class="text-danger"></span>
                                </div>

                                <div class="form-group">
                                    <label asp-for="Telefono"></label>
                                    <input asp-for="Telefono" class="form-control" placeholder="Número de Teléfono">
                                    <span asp-validation-for="Telefono" class="text-danger"></span>
                                </div>

                                <div class="form-group">
                                    <label asp-for="Direccion"></label>
                                    <input asp-for="Direccion" class="form-control" placeholder="Dirección">
                                    <span asp-validation-for="Direccion" class="text-danger"></span>
                                </div>

                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label for="departamentoId">Departamento</label>
                                        <select id="departamentoId" name="DepartamentoId" class="form-control">
                                            @if (Model.Departamentos is not null)
                                            {
                                                @foreach (var item in Model.Departamentos)
                                                {
                                                    <option value="@item.Value">@item.Text</option>
                                                }
                                            }
                                        </select>
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label for="CuidadId">Municipio</label>
                                        <select id="CuidadId" name="MunicipioId" class="form-control">
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group col-md-3">
                                    <label asp-for="CodigoPostal"></label>
                                    <input asp-for="CodigoPostal" class="form-control" placeholder="Código Postal">
                                    <span asp-validation-for="CodigoPostal" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="text-right mt-4">
                            <button type="button" id="btnGuardarPaciente" class="btn btn-success">Enviar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
@section Script
{
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
    <script>
        $(document).ready(function () {
            // Cargar municipios basados en el departamento seleccionado
            $('#departamentoId').change(function () {
                var departamentoId = $(this).val();
                $('#CuidadId').empty().append('<option value="">Seleccione un municipio</option>');

                if (departamentoId === "") {
                    return;
                }

                $.ajax({
                    url: '/Cuidad/GetCiudadesByDepartamento',
                    type: 'GET',
                    data: { departamentoId: departamentoId },
                    success: function (municipios) {
                        $.each(municipios, function (index, municipio) {
                            $('#CuidadId').append('<option value="' + municipio.value + '">' + municipio.text + '</option>');
                        });
                    },
                    error: function () {
                        alert('Error al cargar los municipios.');
                    }
                });
            });

            // Previsualizar la imagen seleccionada
            $('#upload-avatar').change(function (event) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    $('#foto-perfil').attr('src', e.target.result);
                }
                reader.readAsDataURL(event.target.files[0]);
            });

            // Guardar los datos del paciente
            $('#btnGuardarPaciente').click(function () {
                var form = $('#formPaciente');
                if (!form.valid()) {
                    // Si el formulario no es válido, no envíes la solicitud
                    return;
                }

                var formData = new FormData(form[0]); // Capturar todos los datos del formulario

                $.ajax({
                    url: form.attr('action'), // URL del formulario
                    type: 'POST',
                    data: formData,
                    contentType: false, // Necesario para subir archivos
                    processData: false, // Necesario para subir archivos
                    success: function (response) {
                        // Manejar la respuesta
                        if (response.success) {
                            // Llamar al endpoint de detalles del paciente
                            $.ajax({
                                url: '/Paciente/GetDetallesPaciente', // Cambiar al controlador y acción correctos
                                type: 'GET',
                                data: { pacienteId: response.pacienteId }, // Asegúrate de que `pacienteId` esté en la respuesta
                                success: function (detalles) {
                                    // Limpiar el contenedor antes de actualizar los detalles
                                    $('#container').empty();

                                    // Actualizar la vista con los detalles del paciente
                                    $('#container').html(detalles);
                                },
                                error: function () {
                                    alert('Error al obtener los detalles del paciente.');
                                }
                            });
                        } else {
                            // Mostrar mensajes de error si es necesario
                            alert('Error al guardar el paciente: ' + response.error);
                        }
                    },
                    error: function () {
                        alert('Error al guardar el paciente.');
                    }
                });
            });
        });
    </script>
}